{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - ë¼ë””ì˜¤ í”Œë¦¬{% endblock %}

{% block content %}
<!-- Welcome Section -->
<section class="welcome-section">
    <div class="welcome-content">
        <h1 class="welcome-title">ì•ˆë…•í•˜ì„¸ìš”, <span class="username">{{ user.display_name }}</span>ë‹˜!</h1>
        <p class="welcome-subtitle">Spotify ê³„ì •ì´ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤</p>
    </div>
</section>

<!-- Program Selection Section -->
<section class="programs-section">
    <h2 class="section-title">í”„ë¡œê·¸ë¨ ì„ íƒ</h2>
    <p class="section-description">êµ¬ë…í•  ë¼ë””ì˜¤ í”„ë¡œê·¸ë¨ì„ ì„ íƒí•˜ì„¸ìš”. ì„ íƒí•œ í”„ë¡œê·¸ë¨ì˜ ìƒˆë¡œìš´ ê³¡ì´ ìë™ìœ¼ë¡œ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë©ë‹ˆë‹¤.</p>

    <div class="programs-grid" id="programs-grid">
        <div class="loading-spinner">ë¡œë“œ ì¤‘...</div>
    </div>
</section>

<!-- Create Playlist Now Section -->
<section class="create-playlist-section">
    <h2 class="section-title">ì˜¤ëŠ˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒì„±</h2>
    <p class="section-description">êµ¬ë… ì¤‘ì¸ í”„ë¡œê·¸ë¨ì˜ ìµœì‹  ê³¡ìœ¼ë¡œ ìƒˆë¡œìš´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë°”ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="create-playlist-container">
        <button class="btn btn-primary" id="create-now-btn" onclick="createNow()">
            <span class="btn-text">ì§€ê¸ˆ ìƒì„±í•˜ê¸°</span>
            <span class="btn-spinner" style="display: none;">â³ ìƒì„± ì¤‘...</span>
        </button>
        <div id="create-results" style="display: none; margin-top: 16px;"></div>
    </div>
</section>

<!-- Recent Playlists Section -->
<section class="playlists-section">
    <h2 class="section-title">ìµœê·¼ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h2>
    <p class="section-description">ìƒì„±ëœ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ëª©ë¡ì…ë‹ˆë‹¤.</p>

    <div class="playlists-container" id="playlists-container">
        <div class="loading-spinner">ë¡œë“œ ì¤‘...</div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadPrograms();
        loadPlaylists();
    });

    // Load programs from API (uses actual prog_codes)
    async function loadPrograms() {
        try {
            const programs = await fetchAPI('/api/programs/status');
            const container = document.getElementById('programs-grid');

            if (!programs || programs.length === 0) {
                container.innerHTML = '<p class="empty-message">ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            container.innerHTML = programs.map(p => `
                <div class="program-card ${p.is_followed ? 'followed' : ''}" id="card-${p.prog_code}">
                    <div class="program-header">
                        <h3 class="program-title">${p.name}</h3>
                        <span class="program-dj">${p.description || ''}</span>
                    </div>
                    <div class="program-info">
                        <span class="program-channel">ğŸ“» ${p.station}</span>
                    </div>
                    <button
                        class="btn btn-toggle"
                        id="btn-${p.prog_code}"
                        onclick="toggleFollow('${p.prog_code}')"
                        data-followed="${p.is_followed}"
                    >
                        ${p.is_followed ? 'êµ¬ë… ì¤‘ âœ“' : 'êµ¬ë…í•˜ê¸°'}
                    </button>
                </div>
            `).join('');
        } catch (error) {
            document.getElementById('programs-grid').innerHTML = '<p class="error-message">í”„ë¡œê·¸ë¨ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    // Toggle follow
    async function toggleFollow(programCode) {
        const btn = document.getElementById(`btn-${programCode}`);
        const isFollowed = btn.dataset.followed === 'true';
        const endpoint = isFollowed ? 'unfollow' : 'follow';

        btn.disabled = true;
        btn.textContent = 'ì²˜ë¦¬ ì¤‘...';

        try {
            await fetchAPI(`/api/programs/${endpoint}`, {
                method: 'POST',
                body: JSON.stringify({ program_code: programCode })
            });

            btn.dataset.followed = String(!isFollowed);
            btn.textContent = isFollowed ? 'êµ¬ë…í•˜ê¸°' : 'êµ¬ë… ì¤‘ âœ“';

            const card = document.getElementById(`card-${programCode}`);
            if (isFollowed) {
                card.classList.remove('followed');
            } else {
                card.classList.add('followed');
            }

            showToast(isFollowed ? 'êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'í”„ë¡œê·¸ë¨ì„ êµ¬ë…í–ˆìŠµë‹ˆë‹¤.', 'success');
        } catch (error) {
            btn.textContent = isFollowed ? 'êµ¬ë… ì¤‘ âœ“' : 'êµ¬ë…í•˜ê¸°';
        } finally {
            btn.disabled = false;
        }
    }

    // Create playlist now
    async function createNow() {
        const btn = document.getElementById('create-now-btn');
        const btnText = btn.querySelector('.btn-text');
        const btnSpinner = btn.querySelector('.btn-spinner');
        const resultsDiv = document.getElementById('create-results');

        btn.disabled = true;
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline';
        resultsDiv.style.display = 'none';

        try {
            const response = await fetchAPI('/api/playlists/create-now', { method: 'POST' });

            if (response.results && response.results.length > 0) {
                resultsDiv.innerHTML = response.results.map(r => `
                    <div class="result-item" style="padding: 12px; margin-bottom: 8px; border-radius: 8px; background: ${r.success ? '#1DB95420' : '#e74c3c20'};">
                        <strong>${r.program_name || r.program_code}</strong>:
                        ${r.success
                            ? `âœ“ ${r.songs_added}/${r.total_songs}ê³¡ ì¶”ê°€ <a href="${r.playlist_url}" target="_blank" style="color: #1DB954;">[Spotifyì—ì„œ ì—´ê¸°]</a>`
                            : `âœ• ${r.error}`
                        }
                    </div>
                `).join('');
                resultsDiv.style.display = 'block';
                showToast('í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ!', 'success');
                setTimeout(loadPlaylists, 1000);
            } else {
                showToast('êµ¬ë… ì¤‘ì¸ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            // Error already shown via fetchAPI
        } finally {
            btn.disabled = false;
            btnText.style.display = 'inline';
            btnSpinner.style.display = 'none';
        }
    }

    // Load playlists
    async function loadPlaylists() {
        try {
            const playlists = await fetchAPI('/api/playlists');
            const container = document.getElementById('playlists-container');

            if (!playlists || playlists.length === 0) {
                container.innerHTML = '<p class="empty-message">ì•„ì§ ìƒì„±ëœ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œê·¸ë¨ì„ êµ¬ë…í•˜ê³  "ì§€ê¸ˆ ìƒì„±í•˜ê¸°"ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>';
                return;
            }

            container.innerHTML = playlists.map(pl => `
                <div class="playlist-item">
                    <div class="playlist-left">
                        <div class="playlist-info">
                            <h4 class="playlist-name">${pl.playlist_name}</h4>
                            <p class="playlist-date">${formatDateKorean(pl.created_date)}</p>
                            <p class="playlist-program">${pl.program_name} Â· ${pl.program_station}</p>
                        </div>
                    </div>
                    <div class="playlist-right">
                        <span class="playlist-count">${pl.songs_added}/${pl.total_songs}ê³¡</span>
                        ${pl.spotify_playlist_url
                            ? `<a href="${pl.spotify_playlist_url}" target="_blank" class="btn btn-secondary btn-small">Spotifyì—ì„œ ì—´ê¸°</a>`
                            : ''
                        }
                    </div>
                </div>
            `).join('');
        } catch (error) {
            document.getElementById('playlists-container').innerHTML = '<p class="error-message">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }
</script>
{% endblock %}
