{% extends "base.html" %}

{% block title %}ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - ë¼ë””ì˜¤ í”Œë¦¬{% endblock %}

{% block content %}
<!-- Admin Header -->
<section class="admin-header">
    <h1 class="admin-title">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <p class="admin-subtitle">ì‹œìŠ¤í…œ ìƒíƒœ ë° í†µê³„</p>
</section>

<!-- Stats Cards -->
<section class="stats-section">
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-content">
                <h3 class="stat-label">í™œì„± ì‚¬ìš©ì</h3>
                <p class="stat-value" id="total-users">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-content">
                <h3 class="stat-label">ì´ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</h3>
                <p class="stat-value" id="total-playlists">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸµ</div>
            <div class="stat-content">
                <h3 class="stat-label">ì´ ê³¡ ì¶”ê°€</h3>
                <p class="stat-value" id="total-songs">-</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ğŸ“…</div>
            <div class="stat-content">
                <h3 class="stat-label">ë§ˆì§€ë§‰ ì‹¤í–‰</h3>
                <p class="stat-value" id="last-run">-</p>
            </div>
        </div>
    </div>
</section>

<!-- Cache Status Section -->
<section class="cache-section">
    <h2 class="section-title">ìºì‹œ ìƒíƒœ</h2>
    <p class="section-description">ê° í”„ë¡œê·¸ë¨ì˜ ì˜¤ëŠ˜ ì„ ê³¡í‘œ ìºì‹œì…ë‹ˆë‹¤.</p>
    <div class="cache-grid" id="cache-grid">
        <div class="loading-spinner">ë¡œë“œ ì¤‘...</div>
    </div>
</section>

<!-- Manual Jobs Section -->
<section class="jobs-section">
    <h2 class="section-title">ìˆ˜ë™ ì‘ì—…</h2>
    <div class="jobs-grid">
        <div class="job-card">
            <h3>ì„ ê³¡í‘œ ìˆ˜ì§‘</h3>
            <p>ëª¨ë“  í”„ë¡œê·¸ë¨ì˜ ìµœì‹  ì„ ê³¡í‘œë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</p>
            <button class="btn btn-secondary" id="btn-collect" onclick="runJob('/api/admin/run-collect-songs', 'btn-collect')">ì‹¤í–‰</button>
        </div>
        <div class="job-card">
            <h3>í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ìƒì„±</h3>
            <p>ëª¨ë“  ì‚¬ìš©ìì˜ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ë¥¼ ì¦‰ì‹œ ìƒì„±í•©ë‹ˆë‹¤.</p>
            <button class="btn btn-secondary" id="btn-create" onclick="runJob('/api/admin/run-create-playlists', 'btn-create')">ì‹¤í–‰</button>
        </div>
        <div class="job-card">
            <h3>ìºì‹œ ì´ˆê¸°í™”</h3>
            <p>ëª¨ë“  ìºì‹œë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.</p>
            <button class="btn btn-danger" id="btn-clear" onclick="if(confirm('ì •ë§ ìºì‹œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) runJob('/api/admin/clear-cache', 'btn-clear')">ì´ˆê¸°í™”</button>
        </div>
    </div>
</section>

<!-- Program Details Section -->
<section class="program-details-section">
    <h2 class="section-title">í”„ë¡œê·¸ë¨ë³„ í†µê³„</h2>
    <div class="program-details-grid" id="program-details-grid">
        <div class="loading-spinner">ë¡œë“œ ì¤‘...</div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Server-side programs data (passed via Jinja2)
    const PROGRAMS = {{ programs_json|safe }};

    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadCacheStatus();
        loadProgramDetails();
    });

    async function loadStats() {
        try {
            const data = await fetchAPI('/api/admin/stats');
            document.getElementById('total-users').textContent = data.total_users || 0;
            document.getElementById('total-playlists').textContent = data.total_playlists || 0;
            document.getElementById('total-songs').textContent = data.total_songs || 0;
            document.getElementById('last-run').textContent = data.last_run_at ? formatDateKorean(data.last_run_at) : 'ë¯¸ì‹¤í–‰';
        } catch (e) {}
    }

    async function loadCacheStatus() {
        try {
            const data = await fetchAPI('/api/admin/cache-status');
            const cs = data.cache_status || {};
            const container = document.getElementById('cache-grid');

            container.innerHTML = PROGRAMS.map(p => {
                const status = cs[p.prog_code] || {};
                return `
                    <div class="cache-card">
                        <h3 class="cache-program">${p.name}</h3>
                        <p class="cache-station">${p.station}</p>
                        <div class="cache-info">
                            <p>ìºì‹œëœ ê³¡: <strong>${status.songs_count || 0}</strong></p>
                            <p>ì—…ë°ì´íŠ¸: ${status.last_update ? formatDateKorean(status.last_update) : 'ì—†ìŒ'}</p>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="updateCache('${p.prog_code}', this)">ì—…ë°ì´íŠ¸</button>
                    </div>
                `;
            }).join('');
        } catch (e) {
            document.getElementById('cache-grid').innerHTML = '<p class="error-message">ë¡œë“œ ì‹¤íŒ¨</p>';
        }
    }

    async function updateCache(progCode, btn) {
        btn.disabled = true;
        btn.textContent = 'ìˆ˜ì§‘ ì¤‘...';
        try {
            const data = await fetchAPI(`/api/admin/update-cache/${progCode}`, { method: 'POST' });
            showToast(data.message || 'ì™„ë£Œ', 'success');
            loadCacheStatus();
        } catch (e) {} finally {
            btn.disabled = false;
            btn.textContent = 'ì—…ë°ì´íŠ¸';
        }
    }

    async function runJob(url, btnId) {
        const btn = document.getElementById(btnId);
        const origText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'ì‹¤í–‰ ì¤‘...';
        try {
            const data = await fetchAPI(url, { method: 'POST' });
            showToast(data.message || 'ì‘ì—… ì™„ë£Œ', 'success');
            loadStats();
            loadCacheStatus();
            loadProgramDetails();
        } catch (e) {} finally {
            btn.disabled = false;
            btn.textContent = origText;
        }
    }

    async function loadProgramDetails() {
        try {
            const data = await fetchAPI('/api/admin/program-details');
            const details = data.program_details || {};
            const container = document.getElementById('program-details-grid');

            container.innerHTML = PROGRAMS.map(p => {
                const d = details[p.prog_code] || {};
                return `
                    <div class="program-detail-card">
                        <h3>${p.name} <small style="color:#999;">${p.station}</small></h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">êµ¬ë…ì</span>
                                <span class="detail-value">${d.followers || 0}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸</span>
                                <span class="detail-value">${d.playlists_count || 0}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ì´ ê³¡</span>
                                <span class="detail-value">${d.total_songs || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        } catch (e) {
            document.getElementById('program-details-grid').innerHTML = '<p class="error-message">ë¡œë“œ ì‹¤íŒ¨</p>';
        }
    }
</script>
{% endblock %}
